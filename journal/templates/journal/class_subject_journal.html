{% extends 'layouts/base.html' %}
{% load journal_tags %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Заголовок -->
    <div class="row mb-4">
        <div class="col">
            <h2>
                <i class="bi bi-journal-text"></i>
                {{ subject.title }} - {{ class_group.name }}
            </h2>
            <p class="text-muted">
                Четверть: {{ quarter.name }} |
                {{ quarter.start_date|date:"d.m.Y" }} - {{ quarter.end_date|date:"d.m.Y" }}
            </p>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <button class="btn btn-outline-primary" id="manageColumnsBtn">
                    <i class="bi bi-columns-gap"></i> Управление столбцами
                </button>
                <a href="{% url 'journal:yearly_grades' class_group.id subject.id %}"
                   class="btn btn-warning">
                    <i class="bi bi-calendar"></i> Годовые оценки
                </a>
            </div>
        </div>
    </div>

    <!-- Основная таблица -->
    <div class="table-responsive" style="max-height: 70vh;">
        <table class="table table-bordered" id="journalTable">
            <thead class="table-light" style="position: sticky; top: 0;">
                <tr>
                    <th rowspan="2" style="min-width: 200px; position: sticky; left: 0; background: white;">
                        Ученик
                    </th>
                    <th rowspan="2" style="min-width: 100px; position: sticky; left: 200px; background: white;">
                        Средний
                    </th>

                    {% for lesson_data in lessons_with_columns %}
                        <th colspan="{{ lesson_data.columns|length }}" class="text-center"
                            style="background-color: #f8f9fa;">
                            {{ lesson_data.lesson.date|date:"d.m" }}
                            <br>
                            <small class="text-muted">ур. {{ lesson_data.lesson.lesson_number }}</small>
                        </th>
                    {% endfor %}

                    <th rowspan="2" style="min-width: 100px; background-color: #fff3cd;">
                        Четвертная
                    </th>
                </tr>
                <tr>
                    {% for lesson_data in lessons_with_columns %}
                        {% for column in lesson_data.columns %}
                            <th style="min-width: 80px; text-align: center; font-size: 0.9em;">
                                {{ column.grade_column.short_title }}
                                <br>
                                <small class="text-muted" title="{{ column.grade_column.title }}">
                                    в.{{ column.grade_column.weight }}
                                </small>
                            </th>
                        {% endfor %}
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for stats in student_stats %}
                <tr data-student-id="{{ stats.student.id }}">
                    <td style="position: sticky; left: 0; background: white;">
                        <strong>{{ stats.student.user.last_name }} {{ stats.student.user.first_name }}</strong>
                    </td>
                    <td style="position: sticky; left: 200px; background: white; text-align: center;">
                        <span class="badge
                            {% if stats.avg_grade >= 4.5 %}bg-success
                            {% elif stats.avg_grade >= 3.5 %}bg-primary
                            {% elif stats.avg_grade >= 2.5 %}bg-warning
                            {% elif stats.avg_grade %}bg-danger
                            {% else %}bg-secondary{% endif %}">
                            {{ stats.avg_grade|default:"-"|floatformat:2 }}
                        </span>
                    </td>

                    {% for lesson_data in lessons_with_columns %}
                        {% for column in lesson_data.columns %}
                            <td class="grade-cell text-center"
                                data-student-id="{{ stats.student.id }}"
                                data-lesson-column-id="{{ column.id }}"
                                style="cursor: pointer;"
                                title="{{ column.grade_column.title }} (вес: {{ column.grade_column.weight }})">

                                {% with mark=marks_dict|get_item:stats.student.id|get_item:column.id %}
                                    {% if mark %}
                                        <span class="badge
                                            {% if mark.value == 5 %}bg-success
                                            {% elif mark.value == 4 %}bg-primary
                                            {% elif mark.value == 3 %}bg-warning
                                            {% else %}bg-danger{% endif %}"
                                              data-mark-id="{{ mark.id }}">
                                            {{ mark.value }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                        {% endfor %}
                    {% endfor %}

                    <td style="background-color: #fff3cd; text-align: center;">
                        {% if stats.quarterly_grade and stats.quarterly_grade.grade %}
                            <span class="badge
                                {% if stats.quarterly_grade.grade == 5 %}bg-success
                                {% elif stats.quarterly_grade.grade == 4 %}bg-primary
                                {% elif stats.quarterly_grade.grade == 3 %}bg-warning
                                {% else %}bg-danger{% endif %}">
                                {{ stats.quarterly_grade.grade }}
                            </span>
                            {% if stats.quarterly_grade.calculated_grade %}
                                <br>
                                <small class="text-muted">
                                    ({{ stats.quarterly_grade.calculated_grade|floatformat:2 }})
                                </small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно редактирования оценки -->
<div class="modal fade" id="editMarkModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактирование оценки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMarkForm">
                    <input type="hidden" id="editStudentId">
                    <input type="hidden" id="editLessonColumnId">

                    <div class="mb-3">
                        <label class="form-label">Оценка</label>
                        <select class="form-select" id="editMarkValue" required>
                            <option value="">- Выберите оценку -</option>
                            <option value="5">5 (Отлично)</option>
                            <option value="4">4 (Хорошо)</option>
                            <option value="3">3 (Удовлетворительно)</option>
                            <option value="2">2 (Неудовлетворительно)</option>
                            <option value="1">1 (Очень плохо)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Комментарий</label>
                        <textarea class="form-control" id="editMarkComment" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="deleteMarkBtn">Удалить</button>
                <button type="button" class="btn btn-primary" id="saveMarkBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно управления столбцами -->
<div class="modal fade" id="manageColumnsModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Управление столбцами оценок</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Доступные типы оценок</h6>
                        <div id="availableColumns" class="list-group">
                            {% for column in default_columns %}
                                <div class="list-group-item d-flex justify-content-between align-items-center"
                                     data-column-id="{{ column.id }}">
                                    {{ column.title }}
                                    <small class="text-muted">вес: {{ column.weight }}</small>
                                    <button class="btn btn-sm btn-outline-primary add-column-btn"
                                            data-column-id="{{ column.id }}">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Столбцы урока</h6>
                        <div id="lessonColumns" class="list-group sortable">
                            {% for lesson_data in lessons_with_columns %}
                                {% for column in lesson_data.columns %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center"
                                         data-lesson-column-id="{{ column.id }}">
                                        {{ column.grade_column.title }}
                                        <small class="text-muted">вес: {{ column.grade_column.weight }}</small>
                                        <button class="btn btn-sm btn-outline-danger remove-column-btn"
                                                data-lesson-column-id="{{ column.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Редактирование оценки
    $('.grade-cell').click(function() {
        const studentId = $(this).data('student-id');
        const lessonColumnId = $(this).data('lesson-column-id');
        const currentMark = $(this).find('.badge');

        $('#editStudentId').val(studentId);
        $('#editLessonColumnId').val(lessonColumnId);

        if (currentMark.length) {
            $('#editMarkValue').val(currentMark.text().trim());
        } else {
            $('#editMarkValue').val('');
        }

        $('#editMarkComment').val('');

        const modal = new bootstrap.Modal(document.getElementById('editMarkModal'));
        modal.show();
    });

    // Сохранение оценки
    $('#saveMarkBtn').click(function() {
        const studentId = $('#editStudentId').val();
        const lessonColumnId = $('#editLessonColumnId').val();
        const value = $('#editMarkValue').val();
        const comment = $('#editMarkComment').val();

        $.ajax({
            url: '{% url "journal:update_student_mark" %}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                student_id: studentId,
                lesson_column_id: lessonColumnId,
                value: value,
                comment: comment
            }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                if (response.success) {
                    // Обновляем ячейку
                    const cell = $(`.grade-cell[data-student-id="${studentId}"][data-lesson-column-id="${lessonColumnId}"]`);

                    if (response.mark && response.mark.value) {
                        cell.html(`
                            <span class="badge ${getMarkColor(response.mark.value)}"
                                  data-mark-id="${response.mark.id}">
                                ${response.mark.value}
                            </span>
                        `);
                    } else {
                        cell.html('<span class="text-muted">-</span>');
                    }

                    // Обновляем средний балл и четвертную оценку
                    updateStudentStats(studentId, response);

                    bootstrap.Modal.getInstance(document.getElementById('editMarkModal')).hide();
                    showToast('Оценка сохранена', 'success');
                } else {
                    showToast('Ошибка: ' + response.error, 'error');
                }
            }
        });
    });

    // Удаление оценки
    $('#deleteMarkBtn').click(function() {
        if (confirm('Удалить оценку?')) {
            const studentId = $('#editStudentId').val();
            const lessonColumnId = $('#editLessonColumnId').val();

            $.ajax({
                url: '{% url "journal:update_student_mark" %}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    student_id: studentId,
                    lesson_column_id: lessonColumnId,
                    value: null
                }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    if (response.success) {
                        const cell = $(`.grade-cell[data-student-id="${studentId}"][data-lesson-column-id="${lessonColumnId}"]`);
                        cell.html('<span class="text-muted">-</span>');

                        updateStudentStats(studentId, response);

                        bootstrap.Modal.getInstance(document.getElementById('editMarkModal')).hide();
                        showToast('Оценка удалена', 'success');
                    }
                }
            });
        }
    });

    // Управление столбцами
    $('#manageColumnsBtn').click(function() {
        const modal = new bootstrap.Modal(document.getElementById('manageColumnsModal'));
        modal.show();
    });

    // Добавление столбца к уроку
    $(document).on('click', '.add-column-btn', function() {
        const columnId = $(this).data('column-id');
        const lessonId = {{ lessons_with_columns.0.lesson.id|default:0 }};

        $.ajax({
            url: '{% url "journal:manage_lesson_columns" %}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                action: 'add_column',
                lesson_id: lessonId,
                column_id: columnId
            }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    showToast('Ошибка: ' + response.error, 'error');
                }
            }
        });
    });

    // Удаление столбца из урока
    $(document).on('click', '.remove-column-btn', function() {
        if (confirm('Удалить столбец? Все оценки в этом столбце будут удалены.')) {
            const lessonColumnId = $(this).data('lesson-column-id');

            $.ajax({
                url: '{% url "journal:manage_lesson_columns" %}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    action: 'remove_column',
                    column_id: lessonColumnId
                }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        showToast('Ошибка: ' + response.error, 'error');
                    }
                }
            });
        }
    });

    // Вспомогательные функции
    function getMarkColor(grade) {
        switch(parseInt(grade)) {
            case 5: return 'bg-success';
            case 4: return 'bg-primary';
            case 3: return 'bg-warning';
            default: return 'bg-danger';
        }
    }

    function updateStudentStats(studentId, response) {
        // Обновляем средний балл
        const avgCell = $(`tr[data-student-id="${studentId}"] td:nth-child(2) .badge`);
        if (response.quarterly_grade && response.quarterly_grade.calculated_grade) {
            const avg = response.quarterly_grade.calculated_grade;
            avgCell.text(avg.toFixed(2));
            avgCell.removeClass('bg-success bg-primary bg-warning bg-danger bg-secondary');

            if (avg >= 4.5) avgCell.addClass('bg-success');
            else if (avg >= 3.5) avgCell.addClass('bg-primary');
            else if (avg >= 2.5) avgCell.addClass('bg-warning');
            else if (avg > 0) avgCell.addClass('bg-danger');
            else avgCell.addClass('bg-secondary');
        }

        // Обновляем четвертную оценку
        const qGradeCell = $(`tr[data-student-id="${studentId}"] td:last-child`);
        if (response.quarterly_grade && response.quarterly_grade.grade) {
            const grade = response.quarterly_grade.grade;
            qGradeCell.html(`
                <span class="badge ${getMarkColor(grade)}">
                    ${grade}
                </span>
                ${response.quarterly_grade.calculated_grade ?
                  `<br><small class="text-muted">(${response.quarterly_grade.calculated_grade.toFixed(2)})</small>` : ''}
            `);
        } else {
            qGradeCell.html('<span class="text-muted">-</span>');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showToast(message, type) {
        // Реализация уведомлений
        const toast = $(`
            <div class="toast align-items-center text-bg-${type === 'success' ? 'success' : 'danger'} border-0"
                 style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `);

        $('body').append(toast);
        const bsToast = new bootstrap.Toast(toast[0]);
        bsToast.show();

        setTimeout(() => bsToast.hide(), 3000);
    }
});
</script>
{% endblock %}